<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Orem YSA 5th Stake Task Center">
  <meta name="theme-color" content="#5865F2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Stake Tasks">
  <title>Stake Task Center</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://www.churchofjesuschrist.org/favicon.ico">

  <style>
    /* Exact copy of Dashboard Web styles */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;color:#1a1a1a;line-height:1.5}
    .container{max-width:900px;margin:0 auto;padding:16px}
    header{background:linear-gradient(135deg,#5865F2,#7289DA);color:#fff;padding:20px;margin-bottom:20px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    header h1{font-size:22px;font-weight:600}
    .header-right{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .user-info{font-size:14px;opacity:.9}
    .header-btn{background:rgba(255,255,255,.2);border:none;color:#fff;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:13px;transition:background .2s}
    .header-btn:hover{background:rgba(255,255,255,.3)}
    .header-btn:disabled{opacity:.5;cursor:not-allowed}
    .loading{text-align:center;padding:60px 20px;color:#666}
    .spinner{width:40px;height:40px;border:3px solid #e0e0e0;border-top-color:#5865F2;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .summary-bar{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
    .summary-card{background:#fff;padding:16px 20px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.1);flex:1;min-width:100px;text-align:center;cursor:pointer;transition:transform .2s,box-shadow .2s}
    .summary-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .summary-card .number{font-size:28px;font-weight:700;color:#5865F2}
    .summary-card .label{font-size:12px;color:#666;margin-top:2px}
    .summary-card.urgent .number{color:#dc3545}
    .section{background:#fff;border-radius:12px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:hidden}
    .section-header{padding:14px 20px;background:#fafafa;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:background .2s}
    .section-header:hover{background:#f0f0f0}
    .section-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:10px}
    .section-meta{display:flex;align-items:center;gap:10px}
    .section-count{background:#5865F2;color:#fff;padding:2px 10px;border-radius:12px;font-size:12px;font-weight:500}
    .chevron{transition:transform .3s;color:#999;font-size:12px}
    .section-header.expanded .chevron{transform:rotate(180deg)}
    .section-content{max-height:0;overflow:hidden;transition:max-height .3s ease-in-out}
    .section-content.expanded{max-height:5000px}
    .section-inner{padding:16px 20px}
    .bulk-actions{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .item{padding:14px 16px;border:1px solid #e8e8e8;border-radius:8px;margin-bottom:10px;background:#fafafa;transition:border-color .2s}
    .item:hover{border-color:#5865F2}
    .item:last-child{margin-bottom:0}
    .item-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:6px}
    .item-title{font-weight:600;font-size:14px;flex:1}
    .item-meta{font-size:13px;color:#666;margin-bottom:10px}
    .item-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:7px 14px;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:5px;text-decoration:none;transition:all .2s}
    .btn-primary{background:#5865F2;color:#fff}
    .btn-primary:hover{background:#4752c4}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-warning{background:#ffc107;color:#333}
    .btn-warning:hover{background:#e0a800}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-secondary{background:#e8e8e8;color:#333}
    .btn-secondary:hover{background:#d8d8d8}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .empty-state{text-align:center;padding:40px 20px;color:#888}
    .empty-state .icon{font-size:48px;margin-bottom:12px;opacity:.5}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);background:#333;color:#fff;padding:12px 24px;border-radius:8px;font-size:14px;opacity:0;transition:all .3s;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.success{background:#28a745}
    .toast.error{background:#dc3545}
    .hidden{display:none!important}
    .error-page{text-align:center;padding:60px 20px}
    .error-page h2{color:#dc3545;margin-bottom:16px}
    .error-page p{color:#666;line-height:1.6}
    .cc-section{background:#fefbe8;border:1px solid #d4c060}
    .cc-section .section-header{background:#f5eeaa}
    .cc-section .section-header:hover{background:#ede580}
    .cc-section .item{background:#fffde4;border-color:#e8d87a}
    .ack-section{background:#fdf0f5;border:1px solid #e0a8c0}
    .ack-section .section-header{background:#f9d5e5}
    .ack-section .section-header:hover{background:#f5c2d8}
    .ack-section .item{background:#fef6f9;border-color:#ecc5d8}
    .admin-section{background:#fff3cd;border:1px solid #ffc107}
    .admin-section .section-header{background:#fff3cd}
    .settings-label{font-weight:600;font-size:14px;margin-bottom:8px;color:#333}
    .btn-sm{padding:5px 10px;font-size:12px}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s}
    .modal-overlay.show{opacity:1;visibility:visible}
    .modal{background:#fff;border-radius:12px;width:90%;max-width:500px;max-height:90vh;overflow:auto;transform:scale(.9);transition:transform .3s}
    .modal-overlay.show .modal{transform:scale(1)}
    .modal-header{padding:16px 20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:18px;font-weight:600}
    .modal-close{background:none;border:none;font-size:24px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{color:#333}
    .modal-body{padding:20px}
    .modal-footer{padding:16px 20px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px}
    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:6px;font-weight:500;font-size:13px;color:#333}
    .form-select{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px;background:#fff}
    .form-select:focus{outline:none;border-color:#5865F2}
    .form-textarea{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px;background:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;resize:vertical;min-height:80px}
    .form-textarea:focus{outline:none;border-color:#5865F2}
    .form-input{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px;background:#fff}
    .form-input:focus{outline:none;border-color:#5865F2}
    .dashboard-message{background:#e8f4f8;border:1px solid #bee5eb;border-radius:8px;padding:12px 16px;margin-bottom:20px;color:#0c5460;font-size:14px;line-height:1.5}
    .stake-links{background:#fff;border-radius:12px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:hidden}
    .stake-links-header{padding:14px 20px;background:#fafafa;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:background .2s}
    .stake-links-header:hover{background:#f0f0f0}
    .stake-links-content{max-height:0;overflow:hidden;transition:max-height .3s ease-in-out}
    .stake-links-content.expanded{max-height:500px}
    .stake-links-inner{padding:16px 20px;display:flex;flex-wrap:wrap;gap:10px}
    .stake-link{background:#5865F2;color:#fff;padding:8px 16px;border-radius:6px;text-decoration:none;font-size:13px;font-weight:500;transition:background .2s}
    .stake-link:hover{background:#4752c4}
    .settings-group{margin-bottom:20px}
    .settings-label{font-weight:600;font-size:14px;margin-bottom:8px;color:#333}
    .radio-group{display:flex;gap:8px;flex-wrap:wrap}
    .radio-option{padding:8px 14px;border:1px solid #ddd;border-radius:6px;font-size:13px;cursor:pointer;transition:all .2s;background:#fff}
    .radio-option:hover{background:#f5f5f5;border-color:#5865F2}
    .radio-option.selected{background:#5865F2;color:#fff;border-color:#5865F2}
    @media(max-width:600px){.container{padding:12px}header{flex-direction:column;text-align:center}.header-right{width:100%;justify-content:center}.summary-bar{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìã Dashboard</h1>
      <div class="header-right">
        <span class="user-info" id="userInfo">Loading...</span>
        <button class="header-btn" onclick="openNewTaskModal()">‚ûï New Task</button>
        <button class="header-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
        <button class="header-btn" id="refreshBtn" onclick="refreshData()" title="Refresh data">üîÑ Refresh</button>
      </div>
    </header>

    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading your dashboard...</p>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Reassign Modal -->
  <div class="modal-overlay" id="reassignModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Reassign Task</span>
        <button class="modal-close" onclick="closeReassignModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Task</label>
          <div id="reassignTaskText" style="padding:10px;background:#f5f5f5;border-radius:6px;font-size:13px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Primary Assignee(s) *</label>
          <div id="reassignPrimaryContainer"></div>
          <button type="button" class="btn btn-sm btn-secondary" onclick="addReassignPrimary()" style="margin-top:8px;">+ Add Primary</button>
        </div>
        <div class="form-group">
          <label class="form-label">CC Group</label>
          <select class="form-select" id="reassignCCGroup" onchange="onCCGroupChange()">
            <option value="none">None</option>
            <option value="stake-presidency">Stake Presidency</option>
            <option value="extended-stake-presidency">Extended Stake Presidency</option>
            <option value="high-council">High Council</option>
            <option value="other">Other (Select Individuals)</option>
          </select>
        </div>
        <div class="form-group" id="reassignCCIndividualsGroup" style="display:none;">
          <label class="form-label">CC Individuals</label>
          <div id="reassignCCContainer"></div>
          <button type="button" class="btn btn-sm btn-secondary" onclick="addReassignCC()" style="margin-top:8px;">+ Add CC</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeReassignModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitReassign()">Reassign</button>
      </div>
    </div>
  </div>

  <!-- Create Task Modal -->
  <div class="modal-overlay" id="newTaskModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Create New Task</span>
        <button class="modal-close" onclick="closeModal('newTaskModal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Task Description *</label>
          <textarea class="form-textarea" id="taskDescription" placeholder="What needs to be done?"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Assign To *</label>
          <div id="taskAssigneeContainer"></div>
          <button type="button" class="btn btn-sm btn-secondary" onclick="addTaskAssignee()" style="margin-top:8px;">+ Add Assignee</button>
        </div>
        <div class="form-group">
          <label class="form-label">CC (Optional)</label>
          <div id="taskCCContainer"></div>
          <button type="button" class="btn btn-sm btn-secondary" onclick="addTaskCC()" style="margin-top:8px;">+ Add CC</button>
        </div>
        <div class="form-group">
          <label class="form-label">Due Date (Optional)</label>
          <div style="display:flex;gap:8px;">
            <input type="date" class="form-input" id="taskDueDate" style="flex:1">
            <input type="time" class="form-input" id="taskDueTime" style="flex:1">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notes (Optional)</label>
          <textarea class="form-textarea" id="taskNotes" placeholder="Additional notes..." style="min-height:60px"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('newTaskModal')">Cancel</button>
        <button class="btn btn-primary" onclick="createTask()">Create Task</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const API_URL = 'https://script.google.com/macros/s/AKfycbz-8U9EqHl8nvJOypAvg0Q09Y6W6pShuJfvoaJda22LUqYPDZRRSytKZ4go5HERiyhr/exec';

    // Global state
    let userId = null;
    let userData = null;
    let currentData = null;
    let users = [];
    let currentReassignId = null;
    let originalPrimaryIds = [];
    let ccGroupMembers = {};
    let showSettings = false;
    let currentMentionId = null;
    let sectionExpanded = {};

    // Cookie helper functions
    function setCookie(name, value, days) {
      const expires = days ? `; expires=${new Date(Date.now() + days * 864e5).toUTCString()}` : '';
      document.cookie = `${name}=${encodeURIComponent(value)}${expires}; path=/; SameSite=Lax`;
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      return null;
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', initApp);

    function initApp() {
      // Check if running as standalone PWA
      const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

      // Get userId from URL first
      const urlParams = new URLSearchParams(window.location.search);
      userId = urlParams.get('userId');

      // Debug logging
      console.log('PWA Mode:', isStandalone);
      console.log('userId from URL:', userId);
      console.log('Current URL:', window.location.href);

      // If userId in URL, save to both localStorage and cookie for PWA use
      if (userId) {
        try {
          localStorage.setItem('stakeTasksUserId', userId);
          setCookie('stakeTasksUserId', userId, 365);
          console.log('Saved userId to localStorage and cookie:', userId);
        } catch (e) {
          console.error('Failed to save userId:', e);
        }
      } else {
        // If not in URL, try to get from localStorage or cookie (PWA home screen launch)
        try {
          userId = localStorage.getItem('stakeTasksUserId') || getCookie('stakeTasksUserId');
          console.log('Retrieved userId from storage:', userId);
        } catch (e) {
          console.error('Failed to read userId:', e);
        }
      }

      if (!userId) {
        const message = isStandalone
          ? 'To use the home screen app:<br>1. Open your dashboard link in Safari first<br>2. Then add to home screen<br><br>Contact your stake clerk for your link.'
          : 'Please use the link provided in your notification.';
        showErrorPage('No user ID found', message);
        return;
      }

      // Validate userId format
      if (!userId.startsWith('U') || userId.length < 9) {
        showErrorPage('Invalid user ID', 'Please use the link provided in your notification.');
        return;
      }

      // Load dashboard and users
      loadDashboardData();
      loadUsers();
    }

    // API Functions
    async function loadDashboardData(forceRefresh = false) {
      try {
        const url = `${API_URL}?action=getDashboard&userId=${encodeURIComponent(userId)}&forceRefresh=${forceRefresh}`;

        const response = await fetch(url, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (!data.success && data.error) {
          throw new Error(data.error);
        }

        onDataLoaded(data);
      } catch (error) {
        console.error('Load error:', error);
        showToast('Failed to load dashboard: ' + error.message, 'error');
        showErrorPage('Unable to load dashboard', error.message);
      }
    }

    async function performAction(action, params = {}) {
      try {
        params.userId = userId;
        params.action = action;

        // Use GET with URL parameters to avoid CORS preflight issues
        const urlParams = new URLSearchParams();
        for (const key in params) {
          urlParams.append(key, params[key]);
        }
        const url = `${API_URL}?${urlParams.toString()}`;

        const response = await fetch(url, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Action failed');
        }

        return result;
      } catch (error) {
        console.error('Action error:', error);
        throw error;
      }
    }

    // Data handling
    function onDataLoaded(data) {
      currentData = data;
      userData = {
        name: data.userName || userId,
        userId: data.userId || userId,
        canReassign: data.canReassign || false,
        isAdmin: data.isAdmin || false
      };

      document.getElementById('userInfo').textContent = userData.name;
      renderDashboard(data);
    }

    function showErrorPage(title, message) {
      document.getElementById('content').innerHTML = `
        <div class="error-page">
          <h2>${title}</h2>
          <p>${message}</p>
        </div>
      `;
    }

    // Rendering functions
    function renderDashboard(data) {
      let html = '';

      // Dashboard message
      if (data.dashboardMessage) {
        html += `<div class="dashboard-message">${escapeHtml(data.dashboardMessage)}</div>`;
      }

      // Stake links
      if (data.stakeLinks && data.stakeLinks.length > 0) {
        const linksExpanded = sectionExpanded['stakeLinks'] === true;
        html += `<div class="stake-links">
          <div class="stake-links-header" onclick="toggleStakeLinks()">
            <span>üîó Stake Links</span>
            <span class="chevron" id="stakeLinksChevron">${linksExpanded ? '‚ñ≤' : '‚ñº'}</span>
          </div>
          <div class="stake-links-content${linksExpanded ? ' expanded' : ''}" id="stakeLinksContent">
            <div class="stake-links-inner">`;
        data.stakeLinks.forEach(link => {
          html += `<a href="${escapeHtml(link.url)}" target="_blank" class="stake-link">${escapeHtml(link.label)}</a>`;
        });
        html += `</div></div></div>`;
      }

      // Settings section
      if (showSettings) {
        html += renderSettingsSection(data.settings || {});
      }

      // Get counts
      const counts = data.counts || {};
      const approvalCount = counts.pendingCallings || 0;
      const ordinationCount = counts.pendingOrdinations || 0;
      const extendCount = (counts.extendCallings || 0) + (counts.extendReleases || 0);
      const taskCount = counts.myTasks || 0;
      const ccCount = counts.ccItems || 0;

      // Summary bar
      if (approvalCount + ordinationCount + extendCount + taskCount + ccCount > 0) {
        html += '<div class="summary-bar">';

        if (approvalCount > 0) {
          html += `<div class="summary-card urgent" onclick="scrollToSection('approvals')">
            <div class="number">${approvalCount}</div>
            <div class="label">Approvals</div>
          </div>`;
        }

        if (extendCount > 0) {
          html += `<div class="summary-card" onclick="scrollToSection('extend')">
            <div class="number">${extendCount}</div>
            <div class="label">Extend</div>
          </div>`;
        }

        if (ordinationCount > 0) {
          html += `<div class="summary-card" onclick="scrollToSection('ordinations')">
            <div class="number">${ordinationCount}</div>
            <div class="label">Ordinations</div>
          </div>`;
        }

        if (taskCount > 0) {
          html += `<div class="summary-card" onclick="scrollToSection('mytasks')">
            <div class="number">${taskCount}</div>
            <div class="label">My Tasks</div>
          </div>`;
        }

        if (ccCount > 0) {
          html += `<div class="summary-card" onclick="scrollToSection('ccOpen')">
            <div class="number">${ccCount}</div>
            <div class="label">CC Items</div>
          </div>`;
        }

        html += '</div>';
      }

      // Sections
      if (data.approvals && data.approvals.length > 0) {
        html += renderApprovalsSection(data.approvals);
      }

      if (data.extendItems && data.extendItems.length > 0) {
        html += renderExtendSection(data.extendItems);
      }

      if (data.ordinations && data.ordinations.length > 0) {
        html += renderOrdinationsSection(data.ordinations);
      }

      if (data.myTasks && data.myTasks.length > 0) {
        html += renderTasksSection(data.myTasks);
      }

      if (data.ccItems && data.ccItems.length > 0) {
        html += renderCCSection(data.ccItems);
      }

      // Admin Tools section
      if (data.isAdmin && data.adminUsers && data.adminUsers.length > 0) {
        html += renderAdminSection(data.adminUsers);
      }

      // Empty state
      if (!data.approvals?.length && !data.extendItems?.length &&
          !data.ordinations?.length && !data.myTasks?.length && !data.ccItems?.length) {
        html += '<div class="empty-state"><div class="icon">‚ú®</div><p>You\'re all caught up!</p><p style="font-size:12px;color:#999;margin-top:8px">No pending items at this time</p></div>';
      }

      document.getElementById('content').innerHTML = html;
    }

    function renderApprovalsSection(items) {
      let html = '<div class="section"><div class="section-header expanded" onclick="toggleSection(\'approvals\')"><div class="section-title">üìã Calling Approvals</div><div class="section-meta"><span class="section-count">' + items.length + '</span><span class="chevron">‚ñº</span></div></div>';
      html += '<div class="section-content expanded" id="section-approvals"><div class="section-inner">';
      html += '<div class="bulk-actions"><button class="btn btn-success" onclick="approveAll(this)">‚úì Approve All</button></div>';

      items.forEach(item => {
        // Construct itemId in format: "calling_ROWINDEX" or "ordination_ROWINDEX"
        const itemId = (item.type || 'calling') + '_' + item.rowIndex;
        html += `<div class="item">
          <div class="item-header"><div class="item-title">${item.memberName || item.member || 'N/A'}</div></div>
          <div class="item-meta">${item.calling || 'N/A'} - ${item.unit || 'N/A'}</div>
          ${item.urgency ? '<div class="item-meta" style="color:#dc3545;font-weight:600">‚ö†Ô∏è Urgent</div>' : ''}
          ${item.hpNote ? '<div class="item-meta" style="color:#856404;background:#fff3cd;padding:8px;border-radius:4px;margin-top:8px">' + item.hpNote + '</div>' : ''}
          <div class="item-actions">
            <button class="btn btn-success" onclick="handleAction('${itemId}', 'approve', this)">‚úì Approve</button>
            <button class="btn btn-warning" onclick="handleAction('${itemId}', 'concern', this)">‚ö†Ô∏è Concerns</button>
          </div>
        </div>`;
      });

      html += '</div></div></div>';
      return html;
    }

    function renderExtendSection(items) {
      let html = '<div class="section"><div class="section-header expanded" onclick="toggleSection(\'extend\')"><div class="section-title">üìû Extend Calling/Release</div><div class="section-meta"><span class="section-count">' + items.length + '</span><span class="chevron">‚ñº</span></div></div>';
      html += '<div class="section-content expanded" id="section-extend"><div class="section-inner">';

      items.forEach(item => {
        const canReassign = userData.canReassign || false;
        html += `<div class="item">
          <div class="item-header"><div class="item-title">${item.displayText || 'N/A'}</div></div>
          ${item.notes ? '<div class="item-meta">' + item.notes + '</div>' : ''}
          <div class="item-actions">
            <button class="btn btn-success" onclick="handleAction('${item.actionId}', 'accepted', this)">‚úì Extended</button>
            ${canReassign ? `<button class="btn btn-secondary btn-sm" onclick="reassignTask('${item.actionId}', '${escapeHtml(item.displayText)}')">‚Üª Reassign</button>` : ''}
          </div>
        </div>`;
      });

      html += '</div></div></div>';
      return html;
    }

    function renderOrdinationsSection(items) {
      let html = '<div class="section"><div class="section-header expanded" onclick="toggleSection(\'ordinations\')"><div class="section-title">üôè Priesthood Ordinations</div><div class="section-meta"><span class="section-count">' + items.length + '</span><span class="chevron">‚ñº</span></div></div>';
      html += '<div class="section-content expanded" id="section-ordinations"><div class="section-inner">';

      items.forEach(item => {
        // Construct itemId in format: "ordination_ROWINDEX"
        const itemId = (item.type || 'ordination') + '_' + item.rowIndex;
        html += `<div class="item">
          <div class="item-header"><div class="item-title">${item.memberName || item.member || 'N/A'}</div></div>
          <div class="item-meta">${item.office || 'N/A'} - ${item.ward || 'N/A'}</div>
          ${item.urgency ? '<div class="item-meta" style="color:#dc3545;font-weight:600">‚ö†Ô∏è Urgent</div>' : ''}
          <div class="item-actions">
            <button class="btn btn-success" onclick="handleAction('${itemId}', 'approve', this)">‚úì Sustain</button>
            <button class="btn btn-warning" onclick="handleAction('${itemId}', 'concern', this)">‚ö†Ô∏è Concerns</button>
          </div>
        </div>`;
      });

      html += '</div></div></div>';
      return html;
    }

    function renderTasksSection(items) {
      let html = '<div class="section"><div class="section-header expanded" onclick="toggleSection(\'mytasks\')"><div class="section-title">‚úÖ My Tasks</div><div class="section-meta"><span class="section-count">' + items.length + '</span><span class="chevron">‚ñº</span></div></div>';
      html += '<div class="section-content expanded" id="section-mytasks"><div class="section-inner">';

      items.forEach(item => {
        const canReassign = userData.canReassign || false;
        html += `<div class="item">
          <div class="item-header"><div class="item-title">${item.displayText || 'N/A'}</div></div>
          ${item.notes ? '<div class="item-meta">' + item.notes + '</div>' : ''}
          ${item.dueDate ? '<div class="item-meta">Due: ' + item.dueDate + '</div>' : ''}
          <div class="item-actions">
            <button class="btn btn-success" onclick="handleAction('${item.actionId}', 'complete', this)">‚úì Complete</button>
            ${canReassign ? `<button class="btn btn-secondary btn-sm" onclick="reassignTask('${item.actionId}', '${escapeHtml(item.displayText)}')">‚Üª Reassign</button>` : ''}
          </div>
        </div>`;
      });

      html += '</div></div></div>';
      return html;
    }

    function renderCCSection(items) {
      const canReassign = userData.canReassign || false;

      // Split items into open and completed
      const openItems = items.filter(item => item.status !== 'Completed');
      const completedItems = items.filter(item => item.status === 'Completed');

      let html = '';

      // Open CC items section
      if (openItems.length > 0) {
        html += '<div class="section cc-section"><div class="section-header expanded" onclick="toggleSection(\'ccOpen\')"><div class="section-title">üìé CC\'d Items</div><div class="section-meta"><span class="section-count">' + openItems.length + '</span><span class="chevron">‚ñº</span></div></div>';
        html += '<div class="section-content expanded" id="section-ccOpen"><div class="section-inner">';

        openItems.forEach(item => {
          html += `<div class="item">
            <div class="item-header"><div class="item-title">${item.displayText || 'N/A'}</div></div>
            ${item.assignedToNames ? '<div class="item-meta">Assigned to: ' + item.assignedToNames + '</div>' : ''}
            ${item.notes && !item.assignedToNames ? '<div class="item-meta">' + item.notes + '</div>' : ''}
            <div class="item-actions">
              <button class="btn btn-success" onclick="handleAction('${item.actionId}', 'ccComplete', this)">‚úì Mark Complete</button>
              ${canReassign ? `<button class="btn btn-secondary btn-sm" onclick="reassignTask('${item.actionId}', '${escapeHtml(item.displayText)}')">‚Üª Reassign</button>` : ''}
            </div>
          </div>`;
        });

        html += '</div></div></div>';
      }

      // Completed CC items section (to acknowledge)
      if (completedItems.length > 0) {
        html += '<div class="section ack-section"><div class="section-header expanded" onclick="toggleSection(\'ccCompleted\')"><div class="section-title">‚úì Completed CC Items</div><div class="section-meta"><span class="section-count">' + completedItems.length + '</span><span class="chevron">‚ñº</span></div></div>';
        html += '<div class="section-content expanded" id="section-ccCompleted"><div class="section-inner">';

        // Add "Acknowledge All" button if more than one item
        if (completedItems.length > 1) {
          html += '<div class="bulk-actions"><button class="btn btn-secondary btn-sm" onclick="acknowledgeAllCC(this)">‚úì Acknowledge All</button></div>';
        }

        completedItems.forEach(item => {
          html += `<div class="item">
            <div class="item-header"><div class="item-title">${item.displayText || 'N/A'}</div></div>
            ${item.assignedToNames ? '<div class="item-meta">Assigned to: ' + item.assignedToNames + '</div>' : ''}
            <div class="item-meta" style="color:#28a745">‚úì Completed by ${item.completedBy || 'Unknown'}</div>
            <div class="item-actions">
              <button class="btn btn-secondary" onclick="handleAction('${item.actionId}', 'acknowledge', this)">‚úì Acknowledge</button>
              ${canReassign ? `<button class="btn btn-secondary btn-sm" onclick="reassignTask('${item.actionId}', '${escapeHtml(item.displayText)}')">‚Üª Reassign</button>` : ''}
            </div>
          </div>`;
        });

        html += '</div></div></div>';
      }

      return html;
    }

    function renderAdminSection(adminUsers) {
      let html = '<div class="section admin-section"><div class="section-header expanded" onclick="toggleSection(\'admin\')"><div class="section-title">üîß Admin Tools</div><div class="section-meta"><span class="chevron">‚ñº</span></div></div>';
      html += '<div class="section-content expanded" id="section-admin"><div class="section-inner">';

      html += '<div style="margin-bottom:20px;"><div class="settings-label">üìú Run Scripts</div>';
      html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">';
      html += '<button class="btn btn-primary" onclick="runScript(\'CallingApprovals\')">Process Calling Approvals</button>';
      html += '<button class="btn btn-primary" onclick="runScript(\'PriesthoodOrdinations\')">Process Priesthood Ordinations</button>';
      html += '<button class="btn btn-primary" onclick="runScript(\'StakeBusinessDoc\')">Generate Stake Business Doc</button>';
      html += '<button class="btn btn-primary" onclick="runScript(\'NotificationBlast\')">Manual Notification Blast</button>';
      html += '</div></div>';

      html += '<div><div class="settings-label">üë§ View Another User\'s Dashboard</div>';
      html += '<div style="display:flex;gap:8px;align-items:center;margin-top:8px;">';
      html += '<select class="form-select" id="adminUserSelect" style="flex:1;max-width:300px;"><option value="">Select a user...</option>';

      adminUsers.forEach(u => {
        let t = u.name + (u.role ? ' (' + u.role + ')' : '');
        if (t.length > 50) t = t.substring(0, 47) + '...';
        html += '<option value="' + u.id + '">' + escapeHtmlDisplay(t) + '</option>';
      });

      html += '</select><button class="btn btn-primary" onclick="openUserDashboard()">Open</button></div></div>';
      html += '</div></div></div>';

      return html;
    }

    // Helper Functions
    function escapeHtml(text) {
      if (!text) return '';
      return String(text).replace(/'/g, '\\\'');
    }

    // UI Functions
    function toggleSection(id, forceOpen) {
      const section = document.getElementById('section-' + id);
      if (!section) return;

      const header = section.previousElementSibling;

      if (forceOpen) {
        section.classList.add('expanded');
        header.classList.add('expanded');
      } else {
        section.classList.toggle('expanded');
        header.classList.toggle('expanded');
      }
    }

    function scrollToSection(id) {
      // First ensure the section is open
      toggleSection(id, true);

      // Then scroll to it smoothly
      const section = document.getElementById('section-' + id);
      if (section) {
        const header = section.previousElementSibling;
        if (header) {
          setTimeout(() => {
            header.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100); // Small delay to let the section expand
        }
      }
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type;

      setTimeout(() => toast.classList.add('show'), 10);

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function refreshData() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥';

      loadDashboardData(true).finally(() => {
        btn.disabled = false;
        btn.textContent = 'üîÑ Refresh';
      });
    }

    // Action Handlers
    async function approveAll(btn) {
      // Immediate visual feedback
      if (btn) {
        btn.disabled = true;
        btn.textContent = '...';
      }

      try {
        await performAction('approveAll', {});
        showToast('All items approved', 'success');
        refreshData();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
        if (btn) {
          btn.disabled = false;
          btn.textContent = '‚úì Approve All';
        }
      }
    }

    async function handleAction(actionId, action, btn) {
      // Immediate visual feedback
      if (btn) {
        btn.disabled = true;
        btn.textContent = '...';
      }

      try {
        await performAction(action, { itemId: actionId });
        showToast('Action completed', 'success');
        refreshData();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
        // Restore button state on error
        if (btn) {
          btn.disabled = false;
          // Try to restore original text based on action
          if (action === 'approve') btn.textContent = '‚úì Approve';
          else if (action === 'concern') btn.textContent = '‚ö†Ô∏è Concerns';
          else if (action === 'accepted') btn.textContent = '‚úì Extended';
          else if (action === 'ccComplete') btn.textContent = '‚úì Mark Complete';
          else if (action === 'acknowledge') btn.textContent = '‚úì Acknowledge';
          else btn.textContent = 'Action';
        }
      }
    }

    async function acknowledgeAllCC(btn) {
      // Immediate visual feedback
      if (btn) {
        btn.disabled = true;
        btn.textContent = '...';
      }

      try {
        await performAction('ackAllCC', {});
        showToast('All items acknowledged', 'success');
        refreshData();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
        if (btn) {
          btn.disabled = false;
          btn.textContent = '‚úì Acknowledge All';
        }
      }
    }

    async function loadUsers() {
      try {
        const url = `${API_URL}?action=getUsers&userId=${encodeURIComponent(userId)}`;
        const response = await fetch(url, { method: 'GET' });
        if (!response.ok) return;
        const result = await response.json();
        if (result.success && result.users) {
          users = result.users;
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    async function reassignTask(itemId, itemTitle) {
      currentReassignId = itemId;
      document.getElementById('reassignTaskText').textContent = itemTitle;

      const primaryContainer = document.getElementById('reassignPrimaryContainer');
      const ccContainer = document.getElementById('reassignCCContainer');
      const ccGroupSelect = document.getElementById('reassignCCGroup');
      const ccIndividualsGroup = document.getElementById('reassignCCIndividualsGroup');

      primaryContainer.innerHTML = '<div style="color:#666;font-size:13px;">Loading...</div>';
      ccContainer.innerHTML = '';
      ccGroupSelect.value = 'none';
      ccIndividualsGroup.style.display = 'none';

      document.getElementById('reassignModal').classList.add('show');

      try {
        const url = `${API_URL}?action=getTaskAssignments&userId=${encodeURIComponent(userId)}&itemId=${encodeURIComponent(itemId)}`;
        const response = await fetch(url, { method: 'GET' });
        if (!response.ok) throw new Error('Failed to load assignments');

        const result = await response.json();
        if (!result.success) throw new Error(result.error || 'Failed to load');

        const primaryIds = result.primaryIds || [];
        const ccIds = result.ccIds || [];
        const rawGroups = result.groups || result.ccGroupMembers || {};

        // Map groups
        ccGroupMembers = {};
        ['stakePresidency', 'extendedSP', 'highCouncil'].forEach(key => {
          const mapped = key === 'stakePresidency' ? 'stake-presidency' :
                        key === 'extendedSP' ? 'extended-stake-presidency' : 'high-council';
          ccGroupMembers[mapped] = (rawGroups[key] || []).map(m => typeof m === 'string' ? m : m.id);
        });

        originalPrimaryIds = primaryIds.slice();

        // Render primary dropdowns
        if (primaryIds.length === 0) {
          primaryContainer.innerHTML = getUserDropdownWithRemove('reassignPrimary_0', 'Select...', '', true);
        } else {
          primaryContainer.innerHTML = '';
          primaryIds.forEach((pid, i) => {
            primaryContainer.insertAdjacentHTML('beforeend', getUserDropdownWithRemove('reassignPrimary_' + i, 'Select...', pid, true));
          });
        }

        // Detect and set CC group
        const detectedGroup = detectCCGroup(ccIds, primaryIds);
        ccGroupSelect.value = detectedGroup;

        if (detectedGroup === 'other') {
          ccIndividualsGroup.style.display = 'block';
          if (ccIds.length === 0) {
            ccContainer.innerHTML = getUserDropdownWithRemove('reassignCC_0', 'None', '', false);
          } else {
            ccContainer.innerHTML = '';
            ccIds.forEach((cid, i) => {
              ccContainer.insertAdjacentHTML('beforeend', getUserDropdownWithRemove('reassignCC_' + i, 'None', cid, false));
            });
          }
        } else {
          ccIndividualsGroup.style.display = 'none';
        }
      } catch (error) {
        showToast('Error loading task details: ' + error.message, 'error');
        closeReassignModal();
      }
    }

    function getUserDropdownWithRemove(id, placeholder, selectedValue, isPrimary) {
      let h = '<div style="display:flex;gap:8px;margin-bottom:6px;align-items:center;"><select class="form-select" id="' + id + '" style="flex:1;"';
      if (isPrimary) h += ' onchange="onPrimaryChange(this)"';
      h += '><option value="">' + escapeHtmlDisplay(placeholder) + '</option>';
      users.forEach(u => {
        const t = u.name + (u.role ? ' (' + u.role + ')' : '');
        const sel = (u.id === selectedValue) ? ' selected' : '';
        h += '<option value="' + u.id + '"' + sel + '>' + escapeHtmlDisplay(t) + '</option>';
      });
      h += '</select>';
      if (id.indexOf('_0') === -1) {
        h += '<button type="button" class="btn btn-sm btn-secondary" onclick="this.parentElement.remove()">‚úï</button>';
      }
      h += '</div>';
      return h;
    }

    function getUserDropdownWithValue(id, placeholder, selectedValue) {
      let h = '<div style="margin-bottom:6px;"><select class="form-select" id="' + id + '">';
      h += '<option value="">' + escapeHtmlDisplay(placeholder) + '</option>';
      users.forEach(u => {
        const t = u.name + (u.role ? ' (' + u.role + ')' : '');
        const sel = (u.id === selectedValue) ? ' selected' : '';
        h += '<option value="' + u.id + '"' + sel + '>' + escapeHtmlDisplay(t) + '</option>';
      });
      h += '</select></div>';
      return h;
    }

    function escapeHtmlDisplay(text) {
      if (!text) return '';
      return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function detectCCGroup(ccIds, primaryIds) {
      if (ccIds.length === 0) return 'none';
      const ccSet = new Set(ccIds.filter(id => !primaryIds.includes(id)));
      for (const [group, members] of Object.entries(ccGroupMembers)) {
        const memberSet = new Set(members);
        if (ccSet.size === memberSet.size && [...ccSet].every(id => memberSet.has(id))) {
          return group;
        }
      }
      return 'other';
    }

    function addReassignPrimary() {
      const container = document.getElementById('reassignPrimaryContainer');
      const count = container.querySelectorAll('select').length;
      container.insertAdjacentHTML('beforeend', getUserDropdownWithRemove('reassignPrimary_' + count, 'Select...', '', true));
    }

    function addReassignCC() {
      const container = document.getElementById('reassignCCContainer');
      const count = container.querySelectorAll('select').length;
      container.insertAdjacentHTML('beforeend', getUserDropdownWithRemove('reassignCC_' + count, 'None', '', false));
    }

    function onPrimaryChange(selectElement) {
      // Update CC group if needed
      const ccGroupSelect = document.getElementById('reassignCCGroup');
      if (ccGroupSelect.value !== 'other') {
        onCCGroupChange();
      }
    }

    function onCCGroupChange() {
      const ccGroup = document.getElementById('reassignCCGroup').value;
      const ccIndividualsGroup = document.getElementById('reassignCCIndividualsGroup');

      if (ccGroup === 'other') {
        ccIndividualsGroup.style.display = 'block';
      } else {
        ccIndividualsGroup.style.display = 'none';
      }
    }

    function closeReassignModal() {
      document.getElementById('reassignModal').classList.remove('show');
      currentReassignId = null;
    }

    async function submitReassign() {
      try {
        // Collect primary assignees
        const primarySelects = document.querySelectorAll('[id^="reassignPrimary_"]');
        const primaryIds = Array.from(primarySelects)
          .map(s => s.value)
          .filter(v => v);

        if (primaryIds.length === 0) {
          showToast('Please select at least one primary assignee', 'error');
          return;
        }

        // Collect CC assignees
        let ccIds = [];
        const ccGroup = document.getElementById('reassignCCGroup').value;

        if (ccGroup === 'other') {
          const ccSelects = document.querySelectorAll('[id^="reassignCC_"]');
          ccIds = Array.from(ccSelects)
            .map(s => s.value)
            .filter(v => v);
        } else if (ccGroup !== 'none') {
          ccIds = ccGroupMembers[ccGroup] || [];
        }

        // Remove duplicates and primary from CC
        ccIds = ccIds.filter(id => !primaryIds.includes(id));

        await performAction('reassign', {
          itemId: currentReassignId,
          primaryIds: primaryIds.join(','),
          ccIds: ccIds.join(',')
        });

        showToast('Task reassigned successfully', 'success');
        closeReassignModal();
        refreshData();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    // Admin Functions
    async function runScript(scriptName) {
      if (!confirm('Run ' + scriptName + ' script? This will process all pending items.')) return;

      try {
        await performAction('runScript', { scriptName: scriptName });
        showToast('Script started successfully', 'success');
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    function openUserDashboard() {
      const select = document.getElementById('adminUserSelect');
      const selectedUserId = select.value;

      if (!selectedUserId) {
        showToast('Please select a user first', 'error');
        return;
      }

      // Open in new tab
      const url = window.location.origin + window.location.pathname + '?userId=' + encodeURIComponent(selectedUserId);
      window.open(url, '_blank');
    }

    // Settings Functions
    function toggleSettings() {
      showSettings = !showSettings;
      renderDashboard(currentData);
    }

    function toggleStakeLinks() {
      const content = document.getElementById('stakeLinksContent');
      const chevron = document.getElementById('stakeLinksChevron');
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        chevron.textContent = '‚ñº';
        sectionExpanded['stakeLinks'] = false;
      } else {
        content.classList.add('expanded');
        chevron.textContent = '‚ñ≤';
        sectionExpanded['stakeLinks'] = true;
      }
    }

    function renderSettingsSection(settings) {
      const s = settings || {};
      const opts = ['Immediately', 'Hourly', 'Daily', 'None'];

      // Debug logging
      console.log('Settings received:', settings);
      console.log('primaryPref:', s.primaryPref, 'ccPref:', s.ccPref);

      let html = '<div class="section" id="settingsSection"><div class="section-header expanded"><div class="section-title">‚öôÔ∏è Notification Settings</div></div>';
      html += '<div class="section-content expanded"><div class="section-inner">';

      html += '<div class="settings-group"><div class="settings-label">Primary Notifications</div>';
      html += '<div style="font-size:12px;color:#666;margin-bottom:8px;">For tasks assigned to you, callings to extend, clerk reviews, etc.</div>';
      html += '<div class="radio-group">';
      opts.forEach(o => {
        const isSelected = s.primaryPref === o || (!s.primaryPref && o === 'Immediately');
        html += '<div class="radio-option' + (isSelected ? ' selected' : '') + '" onclick="saveSetting(\'primaryPref\',\'' + o + '\',this)">' + o + '</div>';
      });
      html += '</div></div>';

      html += '<div class="settings-group"><div class="settings-label">CC Notifications</div>';
      html += '<div style="font-size:12px;color:#666;margin-bottom:8px;">For items you\'re CC\'d on</div>';
      html += '<div class="radio-group">';
      opts.forEach(o => {
        const isSelected = s.ccPref === o || (!s.ccPref && o === 'Immediately');
        html += '<div class="radio-option' + (isSelected ? ' selected' : '') + '" onclick="saveSetting(\'ccPref\',\'' + o + '\',this)">' + o + '</div>';
      });
      html += '</div></div>';

      html += '</div></div></div>';
      return html;
    }

    async function saveSetting(key, val, element) {
      try {
        // Update UI immediately
        const parent = element.parentElement;
        parent.querySelectorAll('.radio-option').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');

        await performAction('saveSetting', { key: key, value: val });
        showToast('Setting saved', 'success');
      } catch (error) {
        showToast('Error saving setting: ' + error.message, 'error');
      }
    }

    // Create Task Functions
    function openNewTaskModal() {
      document.getElementById('newTaskModal').classList.add('show');
      document.getElementById('taskAssigneeContainer').innerHTML = getUserDropdownWithValue('taskAssignee_0', 'Select...', userId);
      document.getElementById('taskCCContainer').innerHTML = getUserDropdownWithValue('taskCC_0', 'None', '');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
      if (modalId === 'newTaskModal') {
        clearTaskForm();
      }
    }

    function addTaskAssignee() {
      const container = document.getElementById('taskAssigneeContainer');
      const count = container.querySelectorAll('select').length;
      container.insertAdjacentHTML('beforeend', getUserDropdownWithRemove('taskAssignee_' + count, 'Select...', '', false));
    }

    function addTaskCC() {
      const container = document.getElementById('taskCCContainer');
      const count = container.querySelectorAll('select').length;
      container.insertAdjacentHTML('beforeend', getUserDropdownWithRemove('taskCC_' + count, 'None', '', false));
    }

    async function createTask() {
      const desc = document.getElementById('taskDescription').value.trim();
      const date = document.getElementById('taskDueDate').value;
      const time = document.getElementById('taskDueTime').value;
      const notes = document.getElementById('taskNotes').value.trim();

      const primaryIds = [];
      const ccIds = [];

      document.getElementById('taskAssigneeContainer').querySelectorAll('select').forEach(sel => {
        if (sel.value) primaryIds.push(sel.value);
      });

      document.getElementById('taskCCContainer').querySelectorAll('select').forEach(sel => {
        if (sel.value) ccIds.push(sel.value);
      });

      if (!desc || primaryIds.length === 0) {
        showToast('Please fill required fields', 'error');
        return;
      }

      const dueDate = date + (time ? ' ' + time : '');

      try {
        await performAction('createTask', {
          description: desc,
          primaryIds: primaryIds.join(','),
          ccIds: ccIds.join(','),
          dueDate: dueDate,
          notes: notes
        });

        showToast('Task created', 'success');
        closeModal('newTaskModal');
        refreshData();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    function clearTaskForm() {
      document.getElementById('taskDescription').value = '';
      document.getElementById('taskDueDate').value = '';
      document.getElementById('taskDueTime').value = '';
      document.getElementById('taskNotes').value = '';
    }

    // Service Worker for PWA (optional but makes it a true PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // We'll add this later if needed
      });
    }
  </script>
</body>
</html>
